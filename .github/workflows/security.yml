# Security Check Workflow
name: Security Check
on: [push, pull_request]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run API Key Detection Scan
        run: |
          echo "ğŸ” APIã‚­ãƒ¼æ¤œå‡ºã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œä¸­..."
          
          # APIã‚­ãƒ¼æ¤œå‡ºã‚¹ã‚­ãƒ£ãƒ³
          if grep -r "AIzaSy[a-zA-Z0-9_-]\{35,39\}" . --exclude-dir=node_modules --exclude-dir=.git --exclude="*.md" --exclude-dir=".github" --exclude="SECURITY_*" 2>/dev/null | grep -v "GOOGLE_API_KEY_PATTERN" | grep -v "test" | grep -v "Test" | grep -v "Mock"; then
            echo "ğŸš¨ å®Ÿéš›ã®APIã‚­ãƒ¼ãŒãƒªãƒã‚¸ãƒˆãƒªå†…ã§æ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼"
            echo "è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š"
            grep -r "AIzaSy[a-zA-Z0-9_-]\{35,39\}" . --exclude-dir=node_modules --exclude-dir=.git --exclude="*.md" --exclude-dir=".github" --exclude="SECURITY_*" 2>/dev/null | grep -v "GOOGLE_API_KEY_PATTERN" | grep -v "test" | grep -v "Test" | grep -v "Mock" || true
            exit 1
          else
            echo "âœ… APIã‚­ãƒ¼ã®æµå‡ºã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi
          
          # æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          echo "ğŸ” æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯..."
          
          if find . -name "google-services.json" -not -path "*/node_modules/*" -not -name "*.template" | head -1 | grep -q .; then
            echo "ğŸš¨ google-services.json ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼"
            find . -name "google-services.json" -not -path "*/node_modules/*" -not -name "*.template"
            exit 1
          else
            echo "âœ… æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi
          
          # .env ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          if find . -name ".env*" -not -path "*/node_modules/*" | head -1 | grep -q .; then
            echo "ğŸš¨ .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒªãƒã‚¸ãƒˆãƒªã«å«ã¾ã‚Œã¦ã„ã¾ã™ï¼"
            find . -name ".env*" -not -path "*/node_modules/*"
            exit 1
          else
            echo "âœ… .env ãƒ•ã‚¡ã‚¤ãƒ«ã¯é©åˆ‡ã«é™¤å¤–ã•ã‚Œã¦ã„ã¾ã™"
          fi
          
          echo "ğŸ‰ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
      
      - name: Check .gitignore Configuration
        run: |
          echo "ğŸ” .gitignore ã®è¨­å®šã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          
          # å¿…é ˆã®é™¤å¤–è¨­å®šã‚’ãƒã‚§ãƒƒã‚¯
          required_patterns=(
            ".env"
            "google-services.json"
            "GoogleService-Info.plist"
            "*.keystore"
          )
          
          for pattern in "${required_patterns[@]}"; do
            if grep -q "$pattern" .gitignore; then
              echo "âœ… $pattern ãŒ .gitignore ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™"
            else
              echo "âš ï¸ $pattern ãŒ .gitignore ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            fi
          done