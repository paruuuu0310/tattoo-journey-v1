# セキュリティ脆弱性改善チケット管理

**作成日**: 2025-08-25  
**プロジェクト**: Tattoo Journey 2.0  
**分析対象**: React Native モバイルアプリ + Firebase バックエンド

---

## 🔴 高優先度チケット（緊急対応必要）

### SEC-001: APIキーをgit管理から除外し環境変数化

**ステータス**: ✅ **完了済み**  
**優先度**: 高  
**担当者**: Claude (TDD実装)  
**完了日**: 2025-08-25

**問題概要**:

- Google FirebaseのAPIキー(`AIzaSyDE5FFYI8zEcJuLqkq1uiqOCRreAkZK5uk`)がgit管理下のファイルに平文記載
- Google Vision APIキーが環境変数から取得されているが適切な設定なし

**対象ファイル**:

- `mobile/android/app/google-services.json:19`
- `mobile/ios/TattooJourneyMobile/GoogleService-Info.plist`
- `mobile/src/services/GoogleVisionService.ts:44`

**完了した作業内容**:

1. ✅ `.gitignore`にAPIキー含有ファイルを追加
2. ✅ 環境変数での管理システム構築 (EnvironmentConfig.ts)
3. ✅ GitHub Actions セキュリティスキャン設定
4. ✅ 漏洩したAPIキーの無効化 (Firebase Console)
5. ✅ TDDによる包括的テスト実装 (23テスト)

**解決済みリスク**: API不正利用、課金攻撃、データ漏洩を防止

---

### SEC-002: 本番環境でのコンソールログ出力を無効化

**ステータス**: 🔴 未対応  
**優先度**: 高  
**担当者**: 未割り当て  
**期限**: 1週間以内

**問題概要**:

- エラー情報がconsole.errorで直接出力
- 本番環境でセンシティブ情報が漏洩する可能性

**対象ファイル**:

- `mobile/src/contexts/AuthContext.tsx:54,64,75,97,111`
- `mobile/src/services/*.ts` (複数のサービスファイル)

**作業内容**:

1. プロダクションビルドでconsole文を自動削除
2. ログレベル制御システムの導入
3. センシティブ情報のマスキング処理実装
4. 適切なエラー監視システム導入

**リスク**: 情報漏洩、内部仕様の露出

---

### SEC-003: Firebaseセキュリティルールの権限を厳格化

**ステータス**: 🔴 未対応  
**優先度**: 高  
**担当者**: 未割り当て  
**期限**: 2週間以内

**問題概要**:

- ポートフォリオ画像が全認証ユーザーに公開
- チャット画像の削除権限チェックが不十分

**対象ファイル**:

- `firestore.rules:76` (ポートフォリオ読み取り権限)
- `storage.rules:57` (ポートフォリオ画像アクセス)
- `storage.rules:96-98` (チャット画像削除)

**作業内容**:

1. ポートフォリオ画像のアクセス制御見直し
2. 必要最小限の権限に制限
3. チャット画像削除権限の強化
4. アクセスログ監視機能追加

**リスク**: 不正アクセス、プライバシー侵害

---

## 🟡 中優先度チケット（計画的対応）

### SEC-004: メールアドレス検証ロジックの強化

**ステータス**: 🟡 未対応  
**優先度**: 中  
**担当者**: 未割り当て  
**期限**: 3週間以内

**問題概要**:

- 現在の検証パターン`.*@.*\\..*`が簡易的すぎる
- 無効なメール形式を通す可能性

**対象ファイル**:

- `firestore.rules:33-34`

**作業内容**:

1. RFC準拠のメール検証パターンに変更
2. ドメイン検証機能の追加
3. 不正メールフォーマットのブロック機能
4. テストケースの充実

**リスク**: データ整合性の問題、スパム対策不備

---

### SEC-005: 認証状態管理の競合状態対策

**ステータス**: 🟡 未対応  
**優先度**: 中  
**担当者**: 未割り当て  
**期限**: 3週間以内

**問題概要**:

- 認証状態変更時のrace conditionリスク
- ユーザープロフィール取得で競合状態発生の可能性

**対象ファイル**:

- `mobile/src/contexts/AuthContext.tsx:116-130`

**作業内容**:

1. 認証状態変更の順次処理実装
2. タイムアウト処理の追加
3. エラー時の適切な状態復旧処理
4. ローディング状態の最適化

**リスク**: ユーザー体験の悪化、データ不整合

---

### SEC-006: エラー処理の改善とメッセージ分離

**ステータス**: 🟡 未対応  
**優先度**: 中  
**担当者**: 未割り当て  
**期限**: 4週間以内

**問題概要**:

- デバッグ情報とユーザー向けメッセージが混在
- エラー処理の一貫性不足

**対象ファイル**:

- 全サービスファイル
- エラーハンドリング箇所

**作業内容**:

1. ユーザー向けエラーメッセージの統一
2. デバッグ情報の適切な分離
3. エラー分類システムの構築
4. ログ収集・分析システムの導入

**リスク**: ユーザビリティの低下、デバッグ効率の悪化

---

### SEC-008: チャット画像削除権限の強化

**ステータス**: 🟡 未対応  
**優先度**: 中  
**担当者**: 未割り当て  
**期限**: 4週間以内

**問題概要**:

- チャット画像削除時の権限チェックが不十分
- 管理者権限の仕組みが未整備

**対象ファイル**:

- `storage.rules:96-98`

**作業内容**:

1. 削除権限の追加検証ロジック実装
2. 管理者権限システムの構築
3. 削除履歴記録機能の追加
4. 不正削除検知システムの導入

**リスク**: データ保護不備、悪意のあるユーザー対策不足

---

## 🟢 低優先度チケット（改善提案）

### SEC-007: Firebase設定ファイルの環境分離

**ステータス**: 🟢 未対応  
**優先度**: 低  
**担当者**: 未割り当て  
**期限**: 5週間以内

**問題概要**:

- 開発・本番環境の設定が同一ファイルに混在
- エミュレーター設定の管理が不適切

**対象ファイル**:

- `firebase.json`

**作業内容**:

1. 環境別設定ファイルの分離
2. エミュレーター設定の独立化
3. デプロイスクリプトの整備
4. 設定管理の自動化

**リスク**: 運用効率の低下、設定ミス

---

## 📊 実装スケジュール

### Week 1: 緊急セキュリティ対応

- [x] SEC-001: APIキー環境変数化 ✅ **完了済み**
- [ ] SEC-002: コンソールログ制御

### Week 2: 権限制御改善

- [ ] SEC-003: Firebaseセキュリティルール厳格化

### Week 3-4: 機能改善

- [ ] SEC-004: メールアドレス検証強化
- [ ] SEC-005: 認証状態管理改善
- [ ] SEC-006: エラー処理改善

### Week 5: 最適化

- [ ] SEC-008: チャット画像権限強化
- [ ] SEC-007: 設定ファイル環境分離

---

## 📝 チケット更新ログ

| 日付       | チケット | 更新内容                  | 担当者 |
| ---------- | -------- | ------------------------- | ------ |
| 2025-08-25 | ALL      | 初回作成・分析完了        | Claude |
| 2025-08-25 | SEC-001  | TDD実装完了・緊急対応完了 | Claude |

---

## 🔗 関連ドキュメント

- [CLAUDE.md](./CLAUDE.md) - プロジェクト全体指針
- [SECURITY_RULES_GUIDE.md](./SECURITY_RULES_GUIDE.md) - Firebaseセキュリティルール詳細
- [firestore.rules](./firestore.rules) - Firestoreセキュリティルール
- [storage.rules](./storage.rules) - Cloud Storageセキュリティルール

---

**注意**: このファイルは定期的に更新し、進捗状況を管理してください。各チケットの対応時は該当行のステータスを更新し、更新ログに記録してください。
